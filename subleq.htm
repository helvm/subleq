<!DOCTYPE html>
<html lang="en">
<head>
	<title>SUBLEQ eForth</title>
	<meta charset="UTF-8">
	<style type="text/css">
		body{margin:40px auto;max-width:50%;line-height:1.6;font-size:18px;color:#444;padding:0 10px}
		h1,h2,h3{line-height:1.2}
		pre { white-space: pre-wrap; }
		.tab { overflow: hidden; border: 1px solid #ccc; background-color: #f1f1f1; }
		.tab button { background-color: inherit; float: left; border: none; outline: none; cursor: pointer; padding: 14px 16px; transition: 0.3s; }
		.tab button:hover { background-color: #ddd; }
		.tab button.active { background-color: #ccc; } 
		.tabcontent { display: none; padding: 6px 12px; border: 1px solid #ccc; border-top: none; } 
		.blink { animation: blinker 0.6s linear infinite; color: #1f1f1f; font-size: 24px; font-weight: bold; }
		@keyframes blinker { 50% { opacity: 0; } }
	</style>
</head>
<body>
	<!-- TODO: better image loading, save/load image, input only active on correct tab, -->
	<div class="tab">
		<button class="tablinks" onclick="openTab(event, 'subleq')">subleq</button>
		<button class="tablinks" onclick="openTab(event, 'help')">help</button>
		<button class="tablinks" onclick="openTab(event, 'about')">about</button>
		<!--<button class="tablinks" onclick="openTab(event, 'image')">image</button>-->
	</div>

	<div id="subleq" class="tabcontent"> </div>
	<div id="help"   class="tabcontent">
		This system contains a <a href=" https://en.wikipedia.org/wiki/One-instruction_set_computer">SUBLEQ</a> 
		virtual machine that will automatically boot an eForth image, which is a variant of 
		<a href="https://en.wikipedia.org/wiki/Forth_(programming_language)">Forth</a>, a stack
		based programming language suitable for constrained system. A Forth tutorial is beyond
		this help section. However, here are a few commands you can type into the system
		to get started:

		<pre> words </pre>

		This will print out a list of all of the built in functions defined in Forth.

		<pre> 2 2 + . cr </pre>

		Add two numbers together, both 2, and print the result, 4 along with a carriage return.

		<pre> : ahoy cr ." Hello, World!" ; </pre>

		Define a new word (functions are called "words" in Forth) named "ahoy", which when
		called like so:

		<pre> ahoy </pre>

		Will print the standard greeting. If the Forth interpreter is happy, "ok" will be
		printed out after entering each line. Be careful, white-space matters a lot in Forth.

		<p> You can hit ESC to clear the screen and restart the system. </p>
		<p> Happy hacking! </p>
	</div>
	<div id="about" class="tabcontent"> 
		<table style="width:100%">
			<tr> <th>Author</th> <td>Richard James Howe</td> </tr>
			<tr> <th>Project</th> <td>eForth running on SUBLEQ</td> </tr>
			<tr> <th>Email</th> <td><a href="mailto:howe.r.j.89@gmail.com?subject=eForth SUBLEQ">howe.r.j.89@gmail.com</a></td> </tr>
			<tr> <th>Repo</th> <td><a href="https://github.com/howerj/subleq">https://github.com/howerj/subleq</a></td> </tr>
			<tr> <th>License</th> <td>The Unlicense / Public Domain</td> </tr>
		</table> 
	</div>
	<!--<div id="image" class="tabcontent"> <object id="decimal" type="text/html" data="subleq.dec"> </div>-->
	<canvas id="keydown"></canvas>
	<script type="text/javascript">
		function openTab(evt, name) {
			var tabcontent = document.getElementsByClassName("tabcontent");
			for (var i = 0; i < tabcontent.length; i++) { tabcontent[i].style.display = "none"; }
			var tablinks = document.getElementsByClassName("tablinks");
			for (var i = 0; i < tablinks.length; i++) { tablinks[i].className = tablinks[i].className.replace(" active", ""); }
			document.getElementById(name).style.display = "block";
			evt.currentTarget.className += " active";
		}
		document.getElementsByClassName('tablinks')[0].click();

		var file = "https://raw.githubusercontent.com/howerj/subleq/master/subleq.dec";
		var screen = "", input = ".( EFORTH LOADED - USED:) here u. cr\n", cursor = '<b class="blink">_</b>';
		var pc = 0, m = new Uint16Array(65536);
		var redrawTimeout;

		function esc(i) {
			i = i.replace(/&/g, '&amp;');
			i = i.replace(/</g, '&lt;');
			i = i.replace(/>/g, '&gt;');
			return i;
		}

		function colorize(i) { 
			i = i.replace(/\b[0-9]+\b/g, function(x) { return "<b>" + x + "</b>" });
			i = i.replace(/\b(if|else|for|next|aft|then|begin|repeat|until|again)\b/g, function(x) { return "<i>" + x + "</i>" });
			return i;
		}

		function doDraw() {
			document.getElementById('subleq').innerHTML = "<pre>" + colorize(esc(screen)) + cursor + "</pre>";
			window.scrollTo(0, document.body.scrollHeight);
		}

		function draw() { 
			if (redrawTimeout) { /* expensive operation, do not redraw every key-press */
				clearTimeout(redrawTimeout);
				redrawTimeout = null;
			}
			redrawTimeout = setTimeout(doDraw, 50);
		}

		function backspace() {
			let last = screen.slice(-1);
			if (last != '\n' && last != '\r')
				screen = screen.substring(0, screen.length - 1);
		}

		function key2key(k) { /* NB. Fun to funky */
			switch (k) {
			case "Enter": k = '\n'; break;
			case "Escape": k = '\u001B'; break;
			case "Delete": case "Backspace": k = '\u0008'; break;
			default: if (k.length != 1) k = ''; break;
			}
			return k;
		}

		document.documentElement.addEventListener('keydown', function (e) {
			var key = key2key(e.key);
			if (key.length == 0) { return false; }
			else if (key == '\u0008') { backspace(); }
			else if (key == '\u001B') { screen=""; draw(); window.location.reload(); return false; }
			else { screen += key; }
			input += key;
			draw();
			return false; 
		}, false);

		function getch() {
			if (input.length == 0)
				return -1;
			let r = input.charCodeAt(0);
			input = input.substring(1);
			return r;
		}

		function putch(ch) {
			let o = String.fromCharCode(ch);
			if (o == '\u0008') {
				backspace();
			} else {
				screen += o;
			}
			draw();
		}

		function subleq() { /* That's all folks! */
			while ((pc & 0x8000) == 0) {
				let a = m[pc+0];
				let b = m[pc+1];
				let c = m[pc+2];
				if (a == 0xFFFF) {
					let ch = getch();
					if (ch < 0) {
						setTimeout(subleq, 20);
						return;
					}
					m[b] = ch;
					pc += 3;
				} else if (b == 0xFFFF) {
					putch(m[a]);
					pc += 3;
				} else {
					let d = m[b] - m[a];
					m[b] = d;
					if ((d & 0x8000) != 0 || d == 0) pc = c;
					else pc += 3;
				}
				pc &= 0xFFFF;
			}
			window.location.reload();
		}

		console.log("loading file: " + file);
		var t = fetch(file).then(r => r.text()).then(t => {
			var txt = t.split(/[\r?\n]/g);
			for (var i = 0; i < 65536; i++) {
				if (undefined == txt[i]) {
					m[i] = 0;
				} else {
					m[i] = parseInt(txt[i]);
				}
			}
			draw();
			subleq();
		});
	</script>
</body>
</html>
